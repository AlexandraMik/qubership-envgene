FROM python:3.12-alpine
USER root

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

COPY creds_rotation/build/pip.conf /etc/pip.conf
COPY creds_rotation/build/requirements.txt /build/requirements.txt
COPY creds_rotation/scripts /module/scripts
COPY python /python
COPY scripts /build_env/scripts

# Install necessary system packages (only whatâ€™s needed)
RUN  apk update && \
    apk add --no-cache \
        curl \
        sudo \
        # Build dependencies
        gcc \
        musl-dev \
        libffi-dev \
    && curl --retry 3 --retry-connrefused --retry-delay 5 -LO https://github.com/mozilla/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64 \
    && chmod +x sops-v3.9.0.linux.amd64 \
    && mv sops-v3.9.0.linux.amd64 /usr/local/bin/sops \
    && pip install --no-deps --no-cache-dir -r /build/requirements.txt \
    && apk del musl-dev  libffi-dev \
    && pip install --no-cache-dir /python/envgene \
    && pip install --no-cache-dir /python/jschon-sort \
    && pip install --no-cache-dir /python/integration \
    && rm -rf /var/cache/apk/* /tmp/* /var/tmp/* /root/.cache



# Default command to run your script (adjust main.py accordingly)
CMD ["python", "/module/scripts/creds_rotation_handler.py"]